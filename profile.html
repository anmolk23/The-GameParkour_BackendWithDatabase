<!DOCTYPE html>
<html>

<head>
  <title>My Profile - The GameParkour</title>
  <link rel="stylesheet" href="style.css">
  <style>
    .modal-bg {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 50;
    }

    .modal {
      background: #0d0f16;
      padding: 20px;
      width: 340px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.08);
      box-shadow: 0 0 25px rgba(0,0,0,0.6);
    }

    .modal h3 {
      color: #00e5ff;
      margin-bottom: 12px;
      text-align: center;
    }

    .closeModal {
      color: #ff2dd4;
      text-align: right;
      cursor: pointer;
      font-weight: bold;
      margin-bottom: 10px;
    }
  </style>
</head>

<body>

  <div class="navbar">
    <div class="logo">
      <img src="logo.jpg">
      <span>The GameParkour</span>
    </div>

    <div class="nav-links">
      <a href="index.html">Home</a>
      <a class="active" href="profile.html">Profile</a>
      <a href="collection.html">Collection</a>
      <a href="wishlist.html">Wishlist</a>
      <a href="stats.html">Stats</a>
      <a id="authLink" href="login.html">Login</a>
    </div>
  </div>

  <div class="page">
    <h1>My Profile</h1>

    <div class="card">
      <img id="profilePic" class="profile-pic" src="logo.jpg">
      <h2 id="userName">Player Name</h2>
      <p id="userBio">Bio not set.</p>
      <p>Email: <span id="userEmail"></span></p>
      <button class="btn" id="editBtn" style="margin-top:15px;">Edit Profile</button>
    </div>
  </div>

  <div class="footer">© 2025 The GameParkour</div>

  <!-- MODAL -->
  <div id="modalBg" class="modal-bg">
    <div class="modal">
      <div class="closeModal" id="closeModal">X</div>
      <h3>Edit Profile</h3>

      <form id="editProfileForm" enctype="multipart/form-data">
        <input type="text" id="editName" placeholder="New Name">
        <input type="email" id="editEmail" placeholder="New Email">
        <textarea id="editBio" placeholder="Bio / Description" style="height:80px;"></textarea>

        <label style="margin-top:10px; display:block; color:#bfc7d1;">
          Upload New Profile Photo
        </label>

        <input type="file" id="editPhoto" accept="image/*">
        <img id="previewImg" style="width:90px; margin-top:10px; display:none; border-radius:8px;" />

        <button class="btn" type="submit" style="margin-top:15px; width:100%;">Save Changes</button>
      </form>
    </div>
  </div>

  <script>
    // LOAD PROFILE DATA
    async function loadProfile() {
      const res = await fetch("/api/profile", {
        credentials: "include"   // ✅ IMPORTANT
      });

      if (res.status === 401) {
        window.location.href = "login.html";
        return;
      }

      const auth = document.getElementById("authLink");
      auth.textContent = "Logout";
      auth.href = "#";
      auth.onclick = async () => {
        await fetch("/api/logout", {
          method: "POST",
          credentials: "include"   // ✅ IMPORTANT
        });
        window.location = "login.html";
      };

      const data = await res.json();

      if (data.ok) {
        document.getElementById("userName").textContent = data.profile.name;
        document.getElementById("userEmail").textContent = data.profile.email;
        document.getElementById("userBio").textContent = data.profile.bio || "Bio not set.";

        if (data.profile.photo) {
          document.getElementById("profilePic").src = data.profile.photo;
        }

        document.getElementById("editName").value = data.profile.name;
        document.getElementById("editEmail").value = data.profile.email;
        document.getElementById("editBio").value = data.profile.bio || "";
      }
    }

    loadProfile();

    // OPEN MODAL
    document.getElementById("editBtn").onclick = () => {
      document.getElementById("modalBg").style.display = "flex";
    };

    // CLOSE MODAL
    document.getElementById("closeModal").onclick = () => {
      document.getElementById("modalBg").style.display = "none";
    };

    // PHOTO PREVIEW
    document.getElementById("editPhoto").addEventListener("change", function () {
      const file = this.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (e) => {
          const img = document.getElementById("previewImg");
          img.src = e.target.result;
          img.style.display = "block";
        };
        reader.readAsDataURL(file);
      }
    });

    // SUBMIT PROFILE UPDATE
    document.getElementById("editProfileForm").addEventListener("submit", async (e) => {
      e.preventDefault();

      const formData = new FormData();
      formData.append("name", document.getElementById("editName").value);
      formData.append("email", document.getElementById("editEmail").value);
      formData.append("bio", document.getElementById("editBio").value);

      const file = document.getElementById("editPhoto").files[0];
      if (file) formData.append("photo", file);

      const res = await fetch("/api/profile/update", {
        method: "POST",
        credentials: "include",   // ✅ IMPORTANT
        body: formData
      });

      const data = await res.json();

      if (data.ok) {
        alert("Profile updated successfully!");
        document.getElementById("modalBg").style.display = "none";
        loadProfile();
      } else {
        alert("Profile update failed");
      }
    });
  </script>

</body>
</html>
