<!DOCTYPE html>
<html>
<head>
<title>Game Collection - The GameParkour</title>
<link rel="stylesheet" href="/style.css">
</head>
<body>

<div class="navbar">
  <div class="logo">
    <img src="logo.jpg">
    <span>The GameParkour</span>
  </div>
  <div class="nav-links">
    <a href="index.html">Home</a>
    <a href="profile.html">Profile</a>
    <a class="active" href="collection.html">Collection</a>
    <a href="wishlist.html">Wishlist</a>
    <a href="stats.html">Stats</a>
    <a id="authLink" href="login.html">Login</a>
  </div>
</div>

<div class="page">

  <h2>Your Game Collection</h2>

  <div id="collectionList" class="grid"></div>

  <h3 style="margin-top:25px;">Add a new game</h3>

  <form id="addGameForm" class="form-box" style="max-width:350px;">
    <input id="title" placeholder="Game Title" required>
    <input id="genre" placeholder="Genre">
    <input id="hours" type="number" placeholder="Hours Played">
    <button class="btn" type="submit">Add Game</button>
  </form>

</div>

<div class="footer">© 2025 The GameParkour</div>

<script>
// -------------------- LOGIN / LOGOUT TOGGLE --------------------
async function updateAuthLink() {
  const link = document.getElementById("authLink");

  const res = await fetch("/api/profile", {
    credentials: "include"   // ✅ IMPORTANT
  });

  if (res.status === 401) {
    link.textContent = "Login";
    link.href = "login.html";
    return;
  }

  link.textContent = "Logout";
  link.href = "#";

  link.onclick = async () => {
    await fetch("/api/logout", {
      method: "POST",
      credentials: "include"   // ✅ IMPORTANT
    });
    window.location = "login.html";
  };
}

updateAuthLink();


// -------------------- LOAD COLLECTION --------------------
async function loadCollection() {
  const res = await fetch("/api/collection", {
    credentials: "include"   // ✅ IMPORTANT
  });

  if (res.status === 401) {
    window.location = "login.html";
    return;
  }

  const data = await res.json();
  const list = document.getElementById("collectionList");
  list.innerHTML = "";

  if (!data.games || !data.games.length) {
    list.innerHTML = `<p style="color:#bfc7d1">No games added yet.</p>`;
    return;
  }

  data.games.forEach(g => {
    const card = document.createElement("div");
    card.className = "card";
    card.style.position = "relative";
    card.style.paddingBottom = "35px";

    card.innerHTML = `
      <h3>${g.title}</h3>
      <p>Genre: ${g.genre || "Unknown"}</p>
      <p>Hours Played: ${g.hours || 0}</p>

      <button class="btn deleteGame" data-id="${g.id}"
        style="position:absolute; bottom:8px; right:10px; padding:6px 12px;">
        Delete
      </button>
    `;

    list.appendChild(card);
  });

  document.querySelectorAll(".deleteGame").forEach(btn => {
    btn.onclick = async () => {
      const id = btn.dataset.id;

      const res = await fetch(`/api/collection/${id}`, {
        method: "DELETE",
        credentials: "include"   // ✅ IMPORTANT
      });

      if (res.ok) loadCollection();
      else alert("Error deleting game");
    };
  });
}


// -------------------- ADD NEW GAME --------------------
document.getElementById("addGameForm").addEventListener("submit", async e => {
  e.preventDefault();

  const title = document.getElementById("title").value;
  const genre = document.getElementById("genre").value;
  const hours = document.getElementById("hours").value;

  const res = await fetch("/api/collection", {
    method: "POST",
    credentials: "include",   // ✅ IMPORTANT
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ title, genre, hours })
  });

  if (res.ok) {
    e.target.reset();
    loadCollection();
  } else {
    alert("Error adding game");
  }
});

loadCollection();
</script>

</body>
</html>
